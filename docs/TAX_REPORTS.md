# Tax Reports Documentation

Guide for working with tax reports using the B2BRouter PHP SDK.

## Table of Contents

- [Overview](#overview)
- [Tax Report Basics](#tax-report-basics)
- [Retrieving Tax Reports](#retrieving-tax-reports)
- [Tax Report States](#tax-report-states)
- [Monitoring Tax Reports](#monitoring-tax-reports)
- [Working with QR Codes](#working-with-qr-codes)
- [Troubleshooting](#troubleshooting)
- [API Reference](#api-reference)

## Overview

Tax reports are compliance documents automatically generated by B2BRouter based on the fiscal obligations of the invoice issuer. They contain structured invoice data formatted according to local tax authority requirements.

**Important Prerequisites:**
- Tax reports are only generated for issuers subject to specific fiscal obligations (e.g., Spanish Verifactu, Italian SDI, etc.)
- Before tax reports can be generated, you must configure `TaxReportSettings` for your account
- Configuration can be done via the SDK (`$client->taxReportSettings`) or through the B2BRouter web interface

**Key Features:**
- Automatic generation from invoices (when configured and applicable)
- Asynchronous processing and submission to tax authorities
- State tracking via SDK
- QR code generation for verification (where applicable)
- Support for multiple tax jurisdictions

## Tax Report Basics

### What is a Tax Report?

A tax report is a structured document containing:
- Invoice information (number, date, amounts)
- Tax breakdown by category and rate
- Customer and supplier details
- Digital signatures and fingerprints
- Verification identifiers (QR codes, URLs)

### When are Tax Reports Generated?

Tax reports are automatically generated when **all** of the following conditions are met:
1. Your account has `TaxReportSettings` configured for your jurisdiction (via SDK or web interface)
2. Your issuer is subject to fiscal obligations that require tax reporting
3. You create an invoice with `send_after_import: true` OR explicitly send an existing invoice using `$client->invoices->send($invoiceId)`

**Note**: Not all invoices will have tax reports. Only issuers with specific tax reporting obligations (such as Spanish Verifactu requirements) will have tax reports generated for their invoices.

### Supported Tax Report Types

The B2BRouter SDK supports the following tax reporting systems:

| Type | Jurisdiction | Description |
|------|-------------|-------------|
| **Verifactu** | Spain | Real-time reporting to AEAT with hash chains and QR codes |
| **TicketBAI** | Basque Country | Invoicing system for Euskadi |
| **SDI** | Italy | Sistema di Interscambio - Italian electronic invoicing |
| **KSeF** | Poland | National e-Invoicing System |
| **Zatca** | Saudi Arabia | Saudi e-invoicing compliance system |

B2BRouter handles the technical details for each format automatically.

## Retrieving Tax Reports

### From Invoice Response

When you create and send an invoice, the response includes `tax_report_ids`:

```php
<?php

require_once 'vendor/autoload.php';

use B2BRouter\B2BRouterClient;

$client = new B2BRouterClient($_ENV['B2B_API_KEY']);
$accountId = $_ENV['B2B_ACCOUNT_ID'];

// Create and send an invoice
$invoice = $client->invoices->create($accountId, [
    'invoice' => [
        'number' => 'INV-2025-001',
        'date' => date('Y-m-d'),
        'due_date' => date('Y-m-d', strtotime('+30 days')),
        'currency' => 'EUR',
        'contact' => [
            'name' => 'Customer Name',
            'tin_value' => 'ESB12345678',
            'country' => 'ES',
            'email' => 'customer@example.com',
        ],
        'invoice_lines_attributes' => [
            [
                'description' => 'Service or Product',
                'quantity' => 1,
                'price' => 1000.00,
                'taxes_attributes' => [
                    [
                        'name' => 'IVA',
                        'category' => 'S',
                        'percent' => 21.0,
                    ]
                ]
            ]
        ]
    ],
    'send_after_import' => true
]);

// Get tax report IDs
if (!empty($invoice['tax_report_ids'])) {
    foreach ($invoice['tax_report_ids'] as $taxReportId) {
        echo "Tax Report ID: {$taxReportId}\n";
    }
}
```

### Retrieve a Single Tax Report

```php
$taxReportId = $invoice['tax_report_ids'][0];
$taxReport = $client->taxReports->retrieve($taxReportId);

echo "Tax Report Information:\n";
echo "  ID: {$taxReport['id']}\n";
echo "  State: {$taxReport['state']}\n";
echo "  Label: {$taxReport['label']}\n";
echo "  Invoice Number: {$taxReport['invoice_number']}\n";
echo "  Invoice Date: {$taxReport['invoice_date']}\n";
echo "  Type: {$taxReport['type']}\n";
echo "  Created: {$taxReport['created_at']}\n";
echo "  Updated: {$taxReport['updated_at']}\n";
```

### List Tax Reports

```php
// List all tax reports for an account
$taxReports = $client->taxReports->all($accountId, [
    'limit' => 50,
    'offset' => 0,
    'updated_at_from' => '2025-01-01',
]);

echo "Total tax reports: {$taxReports->getTotal()}\n";

foreach ($taxReports as $report) {
    echo "Tax Report {$report['id']}: {$report['label']} - {$report['state']}\n";
}

// Check if there are more results
if ($taxReports->hasMore()) {
    echo "More results available\n";
}
```

### Filter Tax Reports

```php
// Filter by invoice ID
$invoiceTaxReports = $client->taxReports->all($accountId, [
    'invoice_id' => $invoiceId,
]);

// Filter by date range
$recentReports = $client->taxReports->all($accountId, [
    'updated_at_from' => '2025-01-01',
    'updated_at_to' => '2025-01-31',
]);

// Paginate through all results
$offset = 0;
$limit = 100;
$allReports = [];

do {
    $page = $client->taxReports->all($accountId, [
        'limit' => $limit,
        'offset' => $offset,
    ]);

    foreach ($page as $report) {
        $allReports[] = $report;
    }

    $offset += $limit;
} while ($page->hasMore());

echo "Total reports retrieved: " . count($allReports) . "\n";
```

## Tax Report States

Tax reports go through several states during their lifecycle:

### State Flow

```
processing → registered (success)
          ↓
          → error (failure)
          ↓
          → registered_with_errors (partial success)
          ↓
          → annulled (cancelled)
```

### State Descriptions

| State | Description | Final? |
|-------|-------------|--------|
| `processing` | Tax report is being chained and prepared for submission | No |
| `registered` | Successfully submitted and accepted by tax authority | Yes |
| `error` | Submission failed due to validation or system errors | Yes |
| `registered_with_errors` | Submitted successfully but tax authority reported warnings | Yes |
| `annulled` | Tax report has been cancelled/voided | Yes |

### Checking State

```php
$taxReport = $client->taxReports->retrieve($taxReportId);

switch ($taxReport['state']) {
    case 'processing':
        echo "Tax report is still being processed\n";
        break;

    case 'registered':
        echo "Tax report successfully registered\n";
        echo "QR Code: " . (!empty($taxReport['qr']) ? 'Available' : 'Not available') . "\n";
        break;

    case 'error':
        echo "Tax report submission failed\n";
        if (!empty($taxReport['errors'])) {
            print_r($taxReport['errors']);
        }
        break;

    case 'registered_with_errors':
        echo "Tax report registered with warnings\n";
        if (!empty($taxReport['warnings'])) {
            print_r($taxReport['warnings']);
        }
        break;

    case 'annulled':
        echo "Tax report has been cancelled\n";
        break;
}
```

## Monitoring Tax Reports

Since tax reports are processed asynchronously, you need to poll their state to know when processing is complete.

### Polling for Completion

Poll the tax report state periodically until a final state is reached:

```php
/**
 * Wait for tax report to reach a final state
 *
 * @param B2BRouterClient $client
 * @param int $taxReportId
 * @param int $maxAttempts Maximum polling attempts
 * @param int $sleepSeconds Seconds to wait between attempts
 * @return array Result with success status and tax report
 * @throws Exception if timeout occurs
 */
function pollTaxReportState($client, $taxReportId, $maxAttempts = 60, $sleepSeconds = 5) {
    $finalStates = ['registered', 'error', 'registered_with_errors', 'annulled'];
    $attempts = 0;

    while ($attempts < $maxAttempts) {
        $taxReport = $client->taxReports->retrieve($taxReportId);
        $state = $taxReport['state'];

        echo "Attempt {$attempts}: State = {$state}\n";

        if (in_array($state, $finalStates)) {
            return [
                'success' => in_array($state, ['registered', 'registered_with_errors']),
                'state' => $state,
                'tax_report' => $taxReport
            ];
        }

        sleep($sleepSeconds);
        $attempts++;
    }

    throw new Exception("Timeout waiting for tax report after {$maxAttempts} attempts");
}

// Usage
try {
    $result = pollTaxReportState($client, $taxReportId);

    if ($result['success']) {
        echo "Tax report successfully processed!\n";
        $taxReport = $result['tax_report'];

        // Access tax report data
        if (!empty($taxReport['qr'])) {
            file_put_contents("qr_{$taxReportId}.png", base64_decode($taxReport['qr']));
            echo "QR code saved\n";
        }

        if (!empty($taxReport['identifier'])) {
            echo "Verification URL: {$taxReport['identifier']}\n";
        }
    } else {
        echo "Tax report failed: {$result['state']}\n";
        print_r($result['tax_report']['errors']);
    }
} catch (Exception $e) {
    echo "Error: {$e->getMessage()}\n";
}
```

### Polling Best Practices

- **Start with shorter intervals**: 3-5 seconds initially
- **Increase interval over time**: After several attempts, increase to 10-15 seconds
- **Set reasonable timeouts**: Most tax reports complete within 5 minutes
- **Handle errors gracefully**: Check for error states and stop polling
- **Log attempts**: Keep track of polling attempts for debugging

```php
function pollTaxReportWithBackoff($client, $taxReportId) {
    $finalStates = ['registered', 'error', 'registered_with_errors', 'annulled'];
    $attempts = 0;
    $maxAttempts = 40;

    while ($attempts < $maxAttempts) {
        $taxReport = $client->taxReports->retrieve($taxReportId);
        $state = $taxReport['state'];

        if (in_array($state, $finalStates)) {
            return $taxReport;
        }

        // Exponential backoff: start at 3s, max 15s
        $sleepSeconds = min(3 * pow(1.5, floor($attempts / 5)), 15);
        sleep($sleepSeconds);
        $attempts++;
    }

    throw new Exception("Tax report processing timeout");
}
```

## Working with QR Codes

Tax reports for certain jurisdictions (like Spain with Verifactu) include QR codes that customers can scan to verify the invoice with the tax authority.

### Accessing QR Codes

```php
$taxReport = $client->taxReports->retrieve($taxReportId);

if (!empty($taxReport['qr'])) {
    // QR code is base64 encoded PNG image
    $qrImageData = base64_decode($taxReport['qr']);

    // Save to file
    file_put_contents("qr_invoice_{$taxReport['invoice_number']}.png", $qrImageData);
    echo "QR code saved to file\n";

    // Or get as base64 for HTML embedding
    $qrBase64 = $taxReport['qr'];
    $html = "<img src='data:image/png;base64,{$qrBase64}' alt='Verification QR Code' />";
    echo "QR code ready for HTML embedding\n";
}

// Verification URL (human-readable alternative to QR)
if (!empty($taxReport['identifier'])) {
    echo "Verification URL: {$taxReport['identifier']}\n";
    echo "Customers can visit this URL to verify the invoice\n";
}
```

### Complete Example with QR Code

```php
// Create invoice and wait for tax report
$invoice = $client->invoices->create($accountId, [
    'invoice' => [ /* invoice data */ ],
    'send_after_import' => true
]);

$taxReportId = $invoice['tax_report_ids'][0];

// Poll until complete
$taxReport = pollTaxReportState($client, $taxReportId);

// Save QR code if available
if ($taxReport['success'] && !empty($taxReport['tax_report']['qr'])) {
    $invoiceNumber = $taxReport['tax_report']['invoice_number'];
    $qrPath = "qrcodes/invoice_{$invoiceNumber}.png";

    // Ensure directory exists
    if (!is_dir('qrcodes')) {
        mkdir('qrcodes', 0755, true);
    }

    // Save QR code
    $qrData = base64_decode($taxReport['tax_report']['qr']);
    file_put_contents($qrPath, $qrData);

    echo "QR code saved to: {$qrPath}\n";
    echo "Verification URL: {$taxReport['tax_report']['identifier']}\n";
}
```

## Troubleshooting

### Problem: Tax Report Not Generated

**Symptoms:** Invoice created but `tax_report_ids` is empty

**Possible Causes:**
1. `send_after_import` was set to `false`
2. Tax report settings not configured for account
3. Invoice doesn't meet criteria for tax reporting

**Solution:**
```php
// Check if invoice was sent
$invoice = $client->invoices->retrieve($invoiceId);
echo "Invoice state: {$invoice['state']}\n";

// If not sent, send it now to generate tax report
if ($invoice['state'] === 'new') {
    $result = $client->invoices->send($invoiceId);

    // Retrieve invoice again to get tax_report_ids
    $invoice = $client->invoices->retrieve($invoiceId);
    if (!empty($invoice['tax_report_ids'])) {
        echo "Tax report generated: {$invoice['tax_report_ids'][0]}\n";
    }
}
```

## API Reference

### TaxReportService Methods

```php
// Retrieve a single tax report
$taxReport = $client->taxReports->retrieve($taxReportId);

// List tax reports with filters
$taxReports = $client->taxReports->all($accountId, [
    'limit' => 50,
    'offset' => 0,
    'invoice_id' => $invoiceId,           // Filter by invoice
    'sent_at_from' => '2025-01-01',       // Filter by sent date
    'updated_at_from' => '2025-01-01',    // Filter by update date
]);
```

### Tax Report Response Fields

Common fields in tax report responses:

| Field | Type | Description |
|-------|------|-------------|
| `id` | integer | Unique tax report ID |
| `state` | string | Current state (processing, registered, error, etc.) |
| `label` | string | Human-readable label |
| `type` | string | Tax report type (Verifactu, TicketBAI, SDI, KSeF, Zatca) |
| `invoice_id` | integer | Associated invoice ID (if any) |
| `invoice_number` | string | Invoice number |
| `invoice_date` | string | Invoice date (ISO 8601) |
| `invoice_type_code` | string | Invoice type code (F1, R1, etc.) |
| `qr` | string | QR code image (base64 PNG) |
| `identifier` | string | Verification URL |
| `created_at` | string | Creation timestamp |
| `updated_at` | string | Last update timestamp |
| `sent_at` | string | Submission timestamp |
| `ledger_id` | integer | Associated ledger ID |
| `errors` | array | Error messages (if state = error) |
| `warnings` | array | Warning messages |

### Related Documentation

- [Spanish Invoicing Guide](SPANISH_INVOICING.md) - Verifactu compliance for Spain using b2b-php SDK.
- [B2Brouter Verifactu Guide](https://developer.b2brouter.net/v2025-10-13/docs/verifactu) - Full B2Brouter Verifactu Guide.
- [B2BRouter API Reference](https://developer.b2brouter.net/v2025-10-13/reference) - Complete API documentation
- [Tax Report Settings API](https://developer.b2brouter.net/v2025-10-13/reference/tax_report_settings_guide) - Configuration reference
